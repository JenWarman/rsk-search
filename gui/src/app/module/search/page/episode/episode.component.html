<div class="container-fluid pt-3">

  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a [routerLink]="['/search']">Home</a></li>
      <li class="breadcrumb-item active" aria-current="page">{{shortID}}</li>
    </ol>
  </nav>

  <div *ngIf="authenticated && pendingChanges?.length > 0" class="row mb-3">
    <div class="col-12">
      <div class="alert alert-info">
        This episode has an unmerged change. New changes cannot be created until this is resolved.
        <a class="btn btn-sm btn-info" [routerLink]="['/ep', id, 'change', pendingChanges[0].id]">View Change</a>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <div class="card" *ngIf="episode">
        <div class="card-header font-weight-bold">{{ shortID }}</div>
        <div class="card-body pb-2">
          <div class="row">
            <div class="col">
              <table class="table m-0">
                <tr>
                  <th style="width: 200px" class="border-top-0">Broadcast</th>
                  <td class="border-top-0">{{episode.releaseDate}}</td>
                </tr>
                <tr>
                  <th>Transcript Data</th>
                  <td><a target="_blank" href="/dl/episode/{{episode.id}}">{{episode.id}}.json</a></td>
                </tr>
                <tr>
                  <th>Transcribers</th>
                  <td>
                    <span *ngIf="episode.metadata['pilkipedia_url']">
                      <a [href]="episode.metadata['pilkipedia_url']" target="_blank">Pilkipedia</a>
                    </span>
                    <span *ngIf="episode.metadata['pilkipedia_url'] && transcribers"> | </span>
                    <span>{{ transcribers }}</span>
                  </td>
                </tr>
              </table>
            </div>
          </div>
        </div>
        <div *ngIf="episode?.synopses?.length > 0">
          <div class="card-header">
            <div class="d-flex">
              <div class="flex-grow-1 font-weight-bold"><i class="bi bi-card-list mr-1"></i> Synopsis</div>
            </div>
          </div>
          <div class="card-body p-3">
            <ul class="m-0">
              <li *ngFor="let syn of episode?.synopses">
                <span>{{syn.description}} (<a [routerLink]="['/ep', episode?.id]" [fragment]="'pos-'+syn.startPos+'-'+syn.endPos">context</a>)</span>
              </li>
            </ul>
          </div>
        </div>
        <div *ngIf="episode?.trivia?.length > 0">
          <div class="card-header">
            <div class="d-flex">
              <div class="flex-grow-1 font-weight-bold"><i class="bi bi-card-list mr-1"></i> Trivia</div>
            </div>
          </div>
          <div class="card-body p-3">
            <ul class="m-0">
              <li *ngFor="let tri of episode?.trivia">
                <span>{{tri.description}} (<a [routerLink]="['/ep', episode?.id]" [fragment]="'pos-'+tri.startPos+'-'+tri.endPos">context</a>)</span>
              </li>
            </ul>
          </div>
        </div>
        <div *ngIf="quotes && quotes.length > 0">
          <div class="card-header">
            <div class="d-flex">
              <div class="flex-grow-1 font-weight-bold"><i class="bi bi-chat-left-quote mr-1"></i> Quotes</div>
            </div>
          </div>
          <div class="card-body p-3">
            <ul class="m-0">
              <li *ngFor="let quote of quotes">

                <span class="font-italic">"{{quote.content}}" -{{quote.actor}} (<a [routerLink]="['/ep', episode?.id]"
                                                                                   [fragment]="'pos-'+(quote?.pos)">context</a>)</span>
              </li>
            </ul>
          </div>
        </div>
        <div>
          <div class="card-header">
            <div class="d-flex">
              <div class="flex-grow-1 font-weight-bold"><i class="bi bi-voicemail mr-1"></i> Audio</div>
            </div>
          </div>
          <div class="card-body p-3">
            <app-audio-player [src]="audioLink" [playbackRate]="1.0" #audioPlayer></app-audio-player>
            <!--div class="text-right text-sm mt-2">
              alternatve: <a *ngIf="episode.metadata['spotify_uri']"
                             [href]="episode.metadata['spotify_uri'] | safeUrl"> Tinpotradio (spotify)</a>
            </div-->
          </div>
        </div>
        <div class="card-header">
          <div class="d-flex">
            <div class="flex-grow-1 font-weight-bold">
              <i class="bi bi-text-left mr-1"></i> Transcript
              <!-- logic for transcript complete flag incomplete-->
              <span *ngIf="episode.incomplete" class="badge badge-warning ml-3">Incomplete</span>
            </div>
            <!-- disabled to fix synopsis/trivia exports -->
            <!--div *ngIf="authenticated && pendingChanges?.length === 0 && !episode.incomplete">
              <a class="btn btn-sm btn-info" [routerLink]="['/ep', id, 'change']">Submit Correction</a>
            </div-->
          </div>
        </div>
        <div class="card-body p-3">
          <app-transcript
            [transcript]="episode.transcript"
            [scrollToID]="scrollToID"
            [searchResultMode]="false"
            [enableLineLinking]="true"
            (emitAudioTimestamp)="onAudioTimestamp($event)"></app-transcript>
          <div *ngIf="!episode?.transcript?.length" class="text-center p-4">No transcript available.</div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="container-fluid w-25" *ngIf="error && !episode">
  <div class="row">
    <div class="col">
      <div>
        <div class="card">
          <div class="card-body text-center">
            <div>
              <img src="/assets/illustration/pixeltrue-error-1.svg" style="width: 300px"/>
            </div>
            <div class="pb-2"><strong>{{error}}</strong></div>
            <div>Alright, lets see your little website then. Sick of ya...</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<app-loading-overlay [loading]="loading"></app-loading-overlay>
